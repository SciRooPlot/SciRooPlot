#!/bin/bash

export SCIROOPLOT_ROOT="@SCIROOPLOT_ROOT@"
export SCIROOPLOT_BIN="${SCIROOPLOT_ROOT}/@CMAKE_INSTALL_BINDIR@"
export SCIROOPLOT_DATA_DIR="${SCIROOPLOT_ROOT}/share/scirooplot"
export SCIROOPLOT_ENV="${SCIROOPLOT_DATA_DIR}/scirooplot-env.sh"

# enable completion only for interactive shells
case "$-" in
  *i*) ;;
  *) return 1 ;;
esac

if [[ ! -f "${SCIROOPLOT_BIN}/plot" || ! -f "${SCIROOPLOT_BIN}/plot-config" ]]; then
    echo "SciRooPlot is not installed. Cannot initialize plotting functions."
    return 1
fi

function plot() {
  local user_exec=$("${SCIROOPLOT_BIN}/plot-config" "get" "@current" "EXE")
  local user_build_dir=$([[ -n "${user_exec}" ]] && dirname -- "${user_exec}" || echo "")
  if [[ -d "${user_build_dir}" ]]; then

    if [[ "${1}" == "cd" ]]; then
      cd "${user_build_dir}"
      return 0
    fi

    local user_plotdef="$(${SCIROOPLOT_BIN}/plot-config path "@current")/plots.info"
    (
      cd "${user_build_dir}";
      (make -j6 1> /dev/null) || exit 1
      if [[ ! -f "${user_plotdef}" || "${user_exec}" -nt "${user_plotdef}" ]]; then
        "${user_exec}"
      fi
    ) || return 1
  fi
  "${SCIROOPLOT_BIN}/plot" "$@"
  return 0
}

function plot-config() {
  if [[ "${1}" == "create" ]]; then
    local project_name="${2}"
    local project_path="${project_name}"
    [ -n "${3}" ] && project_path="${3}"
    if [[ "${project_path}" != /* ]]; then
      project_path="$(pwd)/${project_path}"
    fi
    if [ -d "${project_path}" ]; then
      echo "Folder ${project_path} already exists. Doing nothing..."
      return 1
    fi
    if [[ -z "${project_name}" ]]; then
      echo "No project name specified. Doing nothing..."
      return 1
    fi
    if [[ "${project_name}" == "@current" ]]; then
      echo "A project cannot be called @current."
      return 1
    fi
    mkdir -p "${project_path}/build"
    cp -r "${SCIROOPLOT_DATA_DIR}/user/"* "${project_path}/"
    sed -i.bak "s/PROJECT_NAME/${project_name}/" "${project_path}/CMakeLists.txt" && rm -f "${project_path}/CMakeLists.txt.bak"
    sed -i.bak "s/PROJECT_NAME/${project_name}/" "${project_path}/DefinePlots.cxx" && rm -f "${project_path}/DefinePlots.cxx.bak"
    "${SCIROOPLOT_BIN}/plot-config" "set" "${project_name}" "EXE" "${project_path}/build/definePlots"
    local curdir="$(pwd)"
    cd "${project_path}/build" && cmake -Wno-dev .. 2>&1 > /dev/null && make 2>&1 > /dev/null && ./definePlots
    cd "${curdir}"
  else
    args=("$@")
    if (( ${#args[@]} >= 4 )) && [[ "${args[4]}" != /* ]]; then
      args[4]="$(pwd)/${args[4]}"
    fi
    "${SCIROOPLOT_BIN}/plot-config" "${args[@]}"
  fi
  return 0
}

_plot_completions_zsh() {

  local modes=('interactive' 'pdf' 'eps' 'svg' 'png' 'gif' 'file' 'find' 'macro')
  local groups
  local groups_and_categories
  local names
  
  local tabcomp_file="$(${SCIROOPLOT_BIN}/plot-config path "@current")/tabcomp.csv"
  if [[ ! -f "${tabcomp_file}" ]]; then
    return
  fi

  # first find groups and groups including categories
  local plotName figureGroup figureCategory
  while IFS="," read -r plotName figureGroup figureCategory
  do
    groups+=("${figureGroup}")
    [ -n "${figureCategory}" ] && groups_and_categories+=("${figureGroup}/${figureCategory}")
  done < <(LC_ALL=C sort -t',' -k2,3 -u "${tabcomp_file}")

  updatePlotNames() {
    local group category
    IFS="/" read -r group category <<< "${1}"
    names=()
    
    local plotName figureGroup figureCategory
    while IFS="," read -r plotName figureGroup figureCategory
    do
      [[ -n "${category}" && "${figureCategory}" != "${category}" && "${figureCategory}" != "${category}/"* ]] && continue
      names+=("${plotName}")
    done < <( grep "^.*,${group},${category}" "${tabcomp_file}" )
  }

  _arguments \
    '1: :->group'\
    '2: :->name'\
    '3: :->mode'


  case $state in
    group)
      if [[ "${words[2]}" == *"/"* ]]; then
        _arguments '1:profiles:(${groups_and_categories})'
      else
        _arguments '1:profiles:(${groups})'
      fi
    ;;
    name)
      if [[ "${words[2]}" == "cd" ]]; then
        _arguments '2:profiles:()'
      else
        updatePlotNames "${words[2]}"
        _arguments '2:profiles:(${names})'
      fi
    ;;
    mode)
      _arguments '3:profiles:(${modes})'
    ;;
  esac

  unset -f updatePlotNames
}

_plot_config_completions_zsh() {

  local general_commands=('create' 'projects' 'reset' 'clean' 'help')
  local project_commands=('remove' 'select' 'show' 'path' 'set' 'get')
  local project_commands_with_prop=('set' 'get')
  local properties=('EXE' 'OUT' 'NAME')

  local projects
  local project_file="$(${SCIROOPLOT_BIN}/plot-config path)/projects.info"
  if [[ -f "${project_file}" ]]; then
    projects=("@current")
    local project
    while read -r project
    do
      projects+=("${project}")
    done < <(grep -B1 '{' "${project_file}" | grep -v '{' | grep -v -- '^--$')
  fi

  _arguments \
    '1: :->command'\
    '2: :->project'\
    '3: :->property'\
    '4: :->setting'

  case "${state}" in
    command)
      _arguments '1:profiles:(${general_commands} ${project_commands})'
    ;;
    project)
      if [[ " ${project_commands[@]} " =~ " ${words[2]} " ]]; then
        _arguments '2:profiles:(${projects})'
      fi
    ;;
    property)
      if [[ " ${project_commands_with_prop[@]} " =~ " ${words[2]} " ]]; then
        _arguments '3:profiles:(${properties})'
      fi
    ;;
  esac
}

_plot_completions_bash() {

  local modes=('interactive pdf eps svg png gif file find macro')
  local groups
  local groups_and_categories
  local names

  local tabcomp_file="$(${SCIROOPLOT_BIN}/plot-config path "@current")/tabcomp.csv"
  if [[ ! -f "${tabcomp_file}" ]]; then
    return
  fi

  # first find groups and groups including categories
  local plotName figureGroup figureCategory
  while IFS="," read -r plotName figureGroup figureCategory
  do
    groups+=" ${figureGroup}"
    [ -n "$figureCategory" ] && groups_and_categories+=" ${figureGroup}/${figureCategory}"
  done < <(LC_ALL=C sort -t',' -k2,3 -u "${tabcomp_file}")

  updatePlotNames() {
    local group category
    IFS="/" read -r group category <<< "${1}"
    names=()
    
    local plotName figureGroup figureCategory
    while IFS="," read -r plotName figureGroup figureCategory
    do
      [[ -n "${category}" && "${figureCategory}" != "${category}" && "${figureCategory}" != "${category}/"* ]] && continue
      names+=" ${plotName}"
    done < <( grep "^.*,${group},${category}" "${tabcomp_file}" )
  }

  case "${COMP_CWORD}" in
  1)
    if [[ "${COMP_WORDS[COMP_CWORD]}" == *"/"* ]]; then
      COMPREPLY=( $(compgen -W "${groups_and_categories}" -- "${COMP_WORDS[COMP_CWORD]}") )
    else
      COMPREPLY=( $(compgen -W "${groups}" -- "${COMP_WORDS[COMP_CWORD]}") )
    fi
  ;;
  2)
    if [[ "${COMP_WORDS[COMP_CWORD-1]}" == "cd" ]]; then
      COMPREPLY=( )
    else
      updatePlotNames "${COMP_WORDS[COMP_CWORD-1]}"
      COMPREPLY=( $(compgen -W "${names}" -- "${COMP_WORDS[COMP_CWORD]}") )
    fi
  ;;
  3)
    COMPREPLY=( $( compgen -W "${modes}" -- "${COMP_WORDS[COMP_CWORD]}" ) )
  ;;
  esac

  unset -f updatePlotNames
}

_plot_config_completions_bash() {

  local general_commands=('create projects reset clean help')
  local project_commands=('remove select show path set get')
  local project_commands_with_prop=('set get')
  local properties=('EXE OUT NAME')
  
  local projects
  local project_file="$(${SCIROOPLOT_BIN}/plot-config path)/projects.info"
  if [[ -f "${project_file}" ]]; then
    projects=("@current")
    local project
    while read -r project
    do
      projects+=" ${project}"
    done < <(grep -B1 '{' "${project_file}" | grep -v '{' | grep -v -- '^--$')
  fi

  case "${COMP_CWORD}" in
  1)
    COMPREPLY=( $(compgen -W "${general_commands} ${project_commands}" -- "${COMP_WORDS[COMP_CWORD]}") )
  ;;
  2)
    if [[ " ${project_commands[@]} " =~ " ${COMP_WORDS[COMP_CWORD-1]} " ]]; then
      COMPREPLY=( $(compgen -W "${projects}" -- "${COMP_WORDS[COMP_CWORD]}") )
    else
      COMPREPLY=( )
    fi
  ;;
  3)
    if [[ " ${project_commands_with_prop[@]} " =~ " ${COMP_WORDS[COMP_CWORD-2]} " ]]; then
      COMPREPLY=( $(compgen -W "${properties}" -- "${COMP_WORDS[COMP_CWORD]}") )
    else
      COMPREPLY=( )
    fi
  ;;
  esac
}

if [ -n "${ZSH_VERSION}" ]; then
  if ! command -v compinit &> /dev/null; then
    autoload -U compinit compdef && compinit
  fi
  if command -v compdef &> /dev/null; then
    compdef _plot_completions_zsh plot
    compdef _plot_config_completions_zsh plot-config
  fi
elif [ -n "${BASH_VERSION}" ]; then
  if ! shopt -q progcomp; then
    BASH_COMPLETION_PATHS=(
      "/usr/share/bash-completion/bash_completion"
      "/etc/bash_completion"
      "/usr/local/etc/bash_completion"
      "/opt/homebrew/etc/bash_completion"
    )

    for bc in "${BASH_COMPLETION_PATHS[@]}"; do
      if [ -r "${bc}" ]; then
        source "${bc}"
        shopt -q progcomp && break
      fi
    done
  fi
  if shopt -q progcomp; then
    complete -F _plot_completions_bash plot
    complete -F _plot_config_completions_bash plot-config
  fi
fi
